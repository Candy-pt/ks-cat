{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card text-center">
                <div class="card-header">
                    <h2><i class="fas fa-qrcode"></i> Scan QR Để Check-in</h2>
                    <p>Quét mã QR tại văn phòng. Cho phép camera và vị trí.</p>
                </div>
                <div class="card-body">
                    <video id="video" width="100%" height="400" autoplay></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div id="result" class="mt-3"></div>
                    <form id="checkinForm" method="POST" enctype="multipart/form-data" style="display: none;">
                        <input type="hidden" name="qr_code" id="qrCode">
                        <input type="hidden" name="gps_lat" id="gpsLat">
                        <input type="hidden" name="gps_lng" id="gpsLng">
                        <input type="file" name="image" id="imageInput" accept="image/*" capture="environment" style="display: none;">
                    </form>
                    <button id="startScan" class="btn btn-primary btn-lg mt-3">Bắt Đầu Scan</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>  <!-- QR lib -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>  <!-- Face detect -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>  <!-- Face-api -->
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let scanning = false;

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(scanQR);  // Bắt đầu scan
    } catch (err) {
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Lỗi camera: ' + err.message + '</div>';
    }
}

function scanQR() {
    if (!scanning) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
            document.getElementById('qrCode').value = code.data;
            document.getElementById('result').innerHTML = '<div class="alert alert-success">QR scan: ' + code.data + '</div>';
            capturePhoto();  // Chụp ảnh
            getGPS();  // Lấy GPS
            return;
        }
    }
    requestAnimationFrame(scanQR);
}

function capturePhoto() {
    const imageInput = document.getElementById('imageInput');
    imageInput.click();  // Trigger camera photo
    imageInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            // Optional face detect
            detectFace(file);
        }
    };
}

async function detectFace(file) {
    const img = new Image();
    img.onload = () => {
        faceapi.nets.tinyFaceDetector.loadFromUri('/static/models').then(() => {
            const detections = faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            if (detections.length > 0) {
                document.getElementById('result').innerHTML += '<div class="alert alert-info">Face detected!</div>';
            } else {
                document.getElementById('result').innerHTML += '<div class="alert alert-warning">No face detected.</div>';
            }
            submitForm();
        });
    };
    img.src = URL.createObjectURL(file);
}

function getGPS() {
    navigator.geolocation.getCurrentPosition((pos) => {
        document.getElementById('gpsLat').value = pos.coords.latitude;
        document.getElementById('gpsLng').value = pos.coords.longitude;
        document.getElementById('result').innerHTML += '<div class="alert alert-info">GPS OK</div>';
    }, (err) => {
        document.getElementById('result').innerHTML += '<div class="alert alert-warning">GPS error: ' + err.message + '</div>';
    });
}

function submitForm() {
    document.getElementById('checkinForm').submit();
}

document.getElementById('startScan').onclick = () => {
    scanning = true;
    startCamera();
};
</script>
{% endblock %}